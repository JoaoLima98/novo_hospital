name: Laravel Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./codificacao/hospital/Hospital 

    steps:
    # 1. Baixa o código (O checkout sempre roda na raiz primeiro, isso é normal)
    - name: Checkout do código
      uses: actions/checkout@v4

    # 2. Debug para garantir que estamos na pasta certa
    - name: Listar arquivos (Debug)
      run: |
        echo "=== ONDE ESTOU AGORA? ==="
        pwd
        echo "=== O QUE TEM AQUI? ==="
        ls -la
        # Se aparecer o artisan e o composer.json aqui, DEU CERTO.

    # 3. Setup PHP
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, sqlite3, zip, unzip, pdo, pdo_sqlite, curl

    # 4. Copia o .env
    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    # 5. Instala dependências
    - name: Install Dependencies
      run: composer install --no-ansi --no-interaction --no-scripts --prefer-dist

    # 6. Gera a chave
    - name: Generate key
      run: php artisan key:generate

    # 7. Cria o banco SQLite
    - name: Create Database
      run: |
        # Como já definimos o working-directory, o 'database/' é relativo à pasta do Laravel
        touch database/database.sqlite
      
    # 8. Roda os testes
    - name: Execute tests
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan test
