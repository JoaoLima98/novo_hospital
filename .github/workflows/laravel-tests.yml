name: Laravel Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    # --- CONFIGURAÇÃO DO DIRETÓRIO ---
    # Define que todos os comandos 'run' rodam nesta pasta.
    # CUIDADO: Linux diferencia maiúsculas (Hospital != hospital).
    # Verifique se o nome da pasta no GitHub é exatamente "Hospital".
    defaults:
      run:
        working-directory: ./codificacao/hospital/Hospital

    steps:
    # 1. Baixa o código
    - name: Checkout do código
      uses: actions/checkout@v4

    # 2. Debug para garantir que o caminho está certo
    - name: Verificar pasta atual (Debug)
      run: |
        echo "=== CAMINHO ATUAL ==="
        pwd
        echo "=== LISTA DE ARQUIVOS ==="
        ls -la
        # Se você ver 'artisan' e 'composer.json' aqui, vai funcionar.

    # 3. Configura o PHP
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite3, pdo_sqlite, bcmath, fileinfo

    # 4. Prepara o arquivo de ambiente
    - name: Copiar .env
      run: cp .env.example .env

    # 5. Instala dependências do Laravel
    - name: Instalar Dependências (Composer)
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    # 6. Corrige permissões (Essencial para não dar erro de log/permissão)
    - name: Corrigir Permissões de Pastas
      run: chmod -R 777 storage bootstrap/cache

    # 7. Gera a chave de criptografia
    - name: Gerar Key
      run: php artisan key:generate

    # 8. Cria o arquivo do banco de dados SQLite vazio
    - name: Criar Banco de Dados SQLite
      run: |
        mkdir -p database
        touch database/database.sqlite

    # 9. Roda os testes usando SQLite
    - name: Executar Testes
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan test
