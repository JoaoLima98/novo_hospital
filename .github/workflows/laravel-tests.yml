name: Laravel Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    steps:
    # 1. Baixa o código
    - name: Checkout do código
      uses: actions/checkout@v4

    # 2. (NOVO) Passo de Debug para ver a estrutura de pastas
    # Se der erro, olhe o log deste passo para ver onde o composer.json está
    - name: Listar arquivos (Debug)
      run: |
        echo "=== LISTANDO DIRETÓRIO ATUAL ==="
        pwd
        ls -la
        echo "=== LISTANDO SUBDIRETÓRIOS ==="
        ls -R

    # 3. Prepara o PHP (CORRIGIDO: adicionei zip, unzip e pdo_sqlite)
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' 
        extensions: mbstring, dom, fileinfo, sqlite3, zip, unzip, pdo, pdo_sqlite, curl

    # 4. Copia o .env
    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    # 5. Instala dependências (CORRIGIDO: removido -q para ver erros)
    - name: Install Dependencies
      run: composer install --no-ansi --no-interaction --no-scripts --prefer-dist

    # 6. Gera a chave
    - name: Generate key
      run: php artisan key:generate

    # 7. Cria o banco SQLite
    - name: Create Database
      run: |
        touch database/database.sqlite
        
    # 8. Roda os testes
    - name: Execute tests
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan test
